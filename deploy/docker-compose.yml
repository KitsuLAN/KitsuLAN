services:
  # ==========================================
  # Core Infrastructure (Default Profile)
  # Запускается всегда при 'docker compose up'
  # ==========================================

  # --- LiveKit Server (SFU) ---
  livekit:
    image: livekit/livekit-server:latest
    container_name: kitsulan_livekit
    command: --config /etc/livekit.yaml
    ports:
      - "7880:7880"   # API / WebSocket
      - "7881:7881"   # TCP (RTC)
      - "7882:7882"   # UDP (RTC)
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    network_mode: "host" # Для локальной разработки LiveKit лучше использовать host networking (на Linux)
    # Если ты на Windows/Mac, убери network_mode и раскомментируй порты UDP диапазона ниже:
    # ports:
    #   - "50000-50200:50000-50200/udp"
    depends_on:
      - redis

  # --- Redis (Message Broker & Cache) ---
  redis:
    image: redis:7-alpine
    container_name: kitsulan_redis
    ports:
      - "6379:6379"
    restart: always


  # --- PostgreSQL (Database) ---
  postgres:
    image: postgres:15-alpine
    container_name: kitsulan_postgres
    environment:
      POSTGRES_USER: kitsu
      POSTGRES_PASSWORD: kitsu_password
      POSTGRES_DB: kitsulan
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always


  # --- MinIO (S3 Compatible Storage - для файлов) ---
  minio:
    image: minio/minio
    container_name: kitsulan_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: kitsu_minio
      MINIO_ROOT_PASSWORD: kitsu_minio_password
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console UI
    volumes:
      - minio_data:/data
    restart: always


  # ==========================================
  # Backend Service (Profile: "app")
  # ==========================================

  kitsulan_service_core:
    container_name: kitsulan_service_core
    build:
      context: ../services/core
      dockerfile: Dockerfile # Используем Production Dockerfile
    # Профиль "app".
    # Если ты хочешь запускать app локально через Air, не указывай этот профиль.
    # Если хочешь запустить всё в докере: docker compose --profile app up
    profiles: ["app"]
    environment:
      - APP_ENV=production
      # Обращаемся к сервисам по их именам в Docker Network
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=kitsu
      - DB_PASSWORD=kitsu_password
      - DB_NAME=kitsulan
      - REDIS_ADDR=redis:6379
      - JWT_SECRET=dev-secret-change-this-in-production-please
    ports:
      - "8090:8090" # gRPC
      - "8091:8091" # Health
      - "8092:8092" # Metrics
    depends_on:
      - postgres
      - redis
      - livekit
    restart: unless-stopped

  # ==========================================
  # Observability Stack (Profile: "monitoring")
  # ==========================================

  # --- Prometheus (Сбор метрик) ---
  prometheus:
    image: prom/prometheus:latest
    container_name: kitsulan_prometheus
    profiles: ["monitoring"]
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    extra_hosts:
      - "host.docker.internal:host-gateway" # Чтобы видеть Go-приложение на хосте (Linux)

  # --- Grafana (Визуализация) ---
  grafana:
    image: grafana/grafana:latest
    container_name: kitsulan_grafana
    profiles: ["monitoring"]
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin # Пароль для входа (admin/admin)
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - postgres

  # --- Loki (Хранилище логов) ---
  loki:
    image: grafana/loki:2.9.8
    container_name: kitsulan_loki
    profiles: ["monitoring"]
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki

  promtail:
    image: grafana/promtail:2.9.8
    container_name: kitsulan_promtail
    profiles: ["monitoring"]
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki


volumes:
  postgres_data:
  minio_data:
  prometheus_data:
  grafana_data:
  loki_data: