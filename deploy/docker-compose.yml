services:
  # --- LiveKit Server (SFU) ---
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    ports:
      - "7880:7880"   # API / WebSocket
      - "7881:7881"   # TCP (RTC)
      - "7882:7882"   # UDP (RTC)
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    network_mode: "host" # Для локальной разработки LiveKit лучше использовать host networking (на Linux)
    # Если ты на Windows/Mac, убери network_mode и раскомментируй порты UDP диапазона ниже:
    # ports:
    #   - "50000-50200:50000-50200/udp"
    depends_on:
      - redis

  # --- Redis (Message Broker & Cache) ---
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # --- PostgreSQL (Database) ---
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: kitsu
      POSTGRES_PASSWORD: kitsu_password
      POSTGRES_DB: kitsulan
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # --- MinIO (S3 Compatible Storage - для файлов) ---
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: kitsu_minio
      MINIO_ROOT_PASSWORD: kitsu_minio_password
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console UI
    volumes:
      - minio_data:/data


  # --- Prometheus (Сбор метрик) ---
  prometheus:
    image: prom/prometheus:latest
    container_name: kitsulan_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    extra_hosts:
      - "host.docker.internal:host-gateway" # Чтобы видеть Go-приложение на хосте (Linux)

  # --- Grafana (Визуализация) ---
  grafana:
    image: grafana/grafana:latest
    container_name: kitsulan_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin # Пароль для входа (admin/admin)
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - postgres

  # --- Loki (Хранилище логов) ---
  loki:
    image: grafana/loki:2.9.8
    container_name: kitsulan_loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki

  promtail:
    image: grafana/promtail:2.9.8
    container_name: kitsulan_promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki


volumes:
  postgres_data:
  minio_data:
  prometheus_data:
  grafana_data:
  loki_data: